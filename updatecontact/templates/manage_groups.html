{% extends "base.html" %}
{% block content %}

<div id="django-messages">
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}
</div>
<div id="loading-spinner" style="display:none;" class="d-flex justify-content-center mt-3">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>
<h2>Manage Facility Groups</h2>


<!-- Step 1: Select an EI System -->
<form method="get">
    <label for="ei_system_id">Select EI System:</label>
    <select name="ei_system_id" id="ei_system_id" onchange="this.form.submit()">
        <option value="">-- Select EI System --</option>
        {% for system in ei_systems %}
            <option value="{{ system.id }}" {% if selected_ei_system and selected_ei_system.id == system.id %}selected{% endif %}>
                {{ system.name }}
            </option>
        {% endfor %}
    </select>
</form>

{% if selected_ei_system %}
    <form method="get" action="{% url 'refresh_facilities' selected_ei_system.id %}" id="refresh-facilities-form">
        <button type="submit" id="refresh-facilities-button">Refresh Available Facilities</button>
    </form>
    <a href="{% url 'search_professional' %}">
        <button type="button">Manage EI Contacts</button>
    </a>
{% endif %}



{% if selected_ei_system %}
    <!-- Step 2: Select an Existing Group -->
    <form method="get" id="select-group-form">
        <input type="hidden" name="ei_system_id" value="{{ selected_ei_system.id }}">
        <label for="group_id">Select Facility Group:</label>
        <select name="group_id" id="group_id" onchange="this.form.submit()">
            <option value="">-- Select Group --</option>
            {% for group in facility_groups %}
                <option value="{{ group.id }}" {% if selected_group and selected_group.id == group.id %}selected{% endif %}>
                    {{ group.name }}
                </option>
            {% endfor %}
        </select>
    </form>

    <!-- Step 3: Create a New Group (Hidden if Group is Selected) -->
    <div id="create-group-section" {% if selected_group %}style="display:none;"{% endif %}>
        <h3>Create New Facility Group</h3>
        <form method="post" id="create-group-form">
            {% csrf_token %}
            <input type="hidden" name="action" value="create_group">
            <input type="hidden" name="ei_system_id" value="{{ selected_ei_system.id }}">
            <label for="new_group_name">Group Name:</label>
            <input type="text" name="new_group_name" required>
            <button type="submit">Create Group</button>
        </form>
    </div>
{% endif %}
<br>
<!-- Step 4: Update Facilities for Selected Group -->
{% if selected_group %}
    <h3>Manage Facilities for Group: {{ selected_group.name }}</h3>
    <form method="post" id="update-group-form">
        {% csrf_token %}
        <input type="hidden" name="action" value="update_groups">
        <input type="hidden" name="group_id" value="{{ selected_group.id }}">
        <input type="hidden" name="ei_system_id" value="{{ selected_ei_system.id }}">
        <button type="submit" class="btn btn-primary mt-2">Update Group</button>
        <!-- Display Current Facilities First -->
        <h3>Current Facilities in Group</h3>
        <div id="current-facilities">
            {% for facility in assigned_facilities %}
                <div>
                    <input type="checkbox" name="facilities" value="{{ facility.id }}" checked>
                    {{ facility.name }}
                </div>
            {% empty %}
                <p>No facilities currently assigned to this group.</p>
            {% endfor %}
        </div>
        <button type="submit" class="btn btn-primary mt-2">Update Group</button>
        <!-- Display Available Facilities Below -->
        <h3>Available Facilities</h3>
        <div id="available-facilities">
            {% for facility in available_facilities %}
                <div>
                    <input type="checkbox" name="facilities" value="{{ facility.id }}">
                    {{ facility.name }}
                </div>
            {% empty %}
                <p>No additional facilities available for assignment.</p>
            {% endfor %}
        </div>

        <button type="submit" class="btn btn-primary mt-2">Update Group</button>
    </form>
{% endif %}

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const groupSelect = document.getElementById("group_id");
        const createGroupSection = document.getElementById("create-group-section");

        if (groupSelect) {
            groupSelect.addEventListener("change", function() {
                if (groupSelect.value) {
                    createGroupSection.style.display = "none";
                } else {
                    createGroupSection.style.display = "block";
                }
            });
        }

        // Show a loading message when refreshing facilities
        const refreshButton = document.getElementById("refresh-facilities-button");
        const refreshForm = document.getElementById("refresh-facilities-form");

        if (refreshButton && refreshForm) {
            refreshButton.addEventListener("click", function (event) {
                event.preventDefault(); // Prevent default button behavior

                let loadingMessage = document.createElement("div");
                loadingMessage.id = "loading-message";
                loadingMessage.innerHTML = "Refreshing facilities, please wait...";
                loadingMessage.style.backgroundColor = "#f0ad4e"; // Bootstrap warning color
                loadingMessage.style.padding = "10px";
                loadingMessage.style.marginTop = "10px";
                loadingMessage.style.color = "#fff";
                loadingMessage.style.textAlign = "center";

                // Insert loading message at the top of the page
                document.body.insertBefore(loadingMessage, document.body.firstChild);
                refreshButton.disabled = true;
                refreshForm.submit();
            });
        }

        const messagesDiv = document.getElementById("django-messages");

        if (messagesDiv && messagesDiv.innerHTML.trim() !== "") {
            const messages = messagesDiv.querySelectorAll(".alert");
            messages.forEach(function(messageElement) {
                // Create a message box for each message
                let messageBox = document.createElement("div");
                messageBox.className = "alert " + (messageElement.className || '');
                messageBox.innerHTML = messageElement.innerHTML;
                messageBox.style.padding = "10px";
                messageBox.style.marginBottom = "10px";
                messageBox.style.textAlign = "center";
                messageBox.style.fontWeight = "bold";

                // Set background color based on alert class
                if (messageElement.classList.contains("alert-success")) {
                    messageBox.style.backgroundColor = "#28a745"; // Green for success
                } else if (messageElement.classList.contains("alert-info")) {
                    messageBox.style.backgroundColor = "#17a2b8"; // Blue for info
                } else if (messageElement.classList.contains("alert-warning")) {
                    messageBox.style.backgroundColor = "#ffc107"; // Yellow for warning
                } else if (messageElement.classList.contains("alert-danger")) {
                    messageBox.style.backgroundColor = "#dc3545"; // Red for danger/error
                }

                // Insert the messageBox at the top of the page content
                document.body.insertBefore(messageBox, document.body.firstChild);

                // Remove after 5 seconds
                setTimeout(function () {
                    messageBox.style.display = "none";
                }, 5000);
            });

            // Hide the original messages div to prevent empty space
            messagesDiv.style.display = "none";
        }
    });
    document.addEventListener("DOMContentLoaded", function() {
    // Example for update-group-form
    const updateGroupForm = document.getElementById("update-group-form");
    const loadingSpinner = document.getElementById("loading-spinner");

    if (updateGroupForm) {
        updateGroupForm.addEventListener("submit", function(event) {
            // Show spinner
            loadingSpinner.style.display = "flex";
        });
    }

    // Hide spinner after some time or when response is received
});
</script>

{% endblock %}
